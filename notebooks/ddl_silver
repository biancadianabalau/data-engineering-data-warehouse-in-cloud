CREATE SCHEMA IF NOT EXISTS silver;

DROP TABLE IF EXISTS silver.customers;
DROP TABLE IF EXISTS silver.customers_old;
DROP TABLE IF EXISTS silver.products;
DROP TABLE IF EXISTS silver.products_old;
DROP TABLE IF EXISTS silver.product_category_translation;
DROP TABLE IF EXISTS silver.product_category_translation_old;
DROP TABLE IF EXISTS silver.sellers;
DROP TABLE IF EXISTS silver.sellers_old;
DROP TABLE IF EXISTS silver.orders;
DROP TABLE IF EXISTS silver.orders_old;
DROP TABLE IF EXISTS silver.order_items;
DROP TABLE IF EXISTS silver.order_items_old;
DROP TABLE IF EXISTS silver.order_payments;
DROP TABLE IF EXISTS silver.order_payments_old;
DROP TABLE IF EXISTS silver.order_reviews;
DROP TABLE IF EXISTS silver.order_reviews_old;
DROP TABLE IF EXISTS silver.geoloaction;
DROP TABLE IF EXISTS silver.geoloaction_old;



-- 1. Customers
CREATE OR REPLACE TABLE silver.customers
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/customers'
AS 
SELECT 
    TRIM(customer_id) AS customer_id,
    TRIM(customer_unique_id) AS customer_unique_id,
    CAST(TRIM(customer_zip_code_prefix) AS INT) AS customer_zip_code_prefix,
    UPPER(TRIM(customer_city)) AS customer_city,
    UPPER(TRIM(customer_state)) AS customer_state,
    current_timestamp() AS _ingested_at
FROM bronze.customers
WHERE customer_id IS NOT NULL;

-- 2. Products 
CREATE OR REPLACE TABLE silver.products
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/products'
AS
SELECT 
    TRIM(product_id) AS product_id,
    COALESCE(NULLIF(UPPER(TRIM(product_category_name)), ''), 'OTHER') AS product_category_name,
    COALESCE(CAST(product_name_lenght AS INT), 0) AS product_name_lenght,
    COALESCE(CAST(product_description_lenght AS INT), 0) AS product_description_lenght,
    COALESCE(CAST(product_photos_qty AS INT), 0) AS product_photos_qty,
    COALESCE(CAST(product_weight_g AS FLOAT), 0) AS product_weight_g,
    COALESCE(CAST(product_length_cm AS FLOAT), 0) AS product_length_cm,
    COALESCE(CAST(product_height_cm AS FLOAT), 0) AS product_height_cm,
    COALESCE(CAST(product_width_cm AS FLOAT), 0) AS product_width_cm
FROM bronze.products;

-- 3. Product Category Translation
CREATE OR REPLACE TABLE silver.product_category_translation
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/product_category_translation'
AS
SELECT 
    UPPER(TRIM(product_category_name)) AS product_category_name,
    UPPER(TRIM(product_category_name_english)) AS product_category_name_english
FROM bronze.product_category_translation;

-- 4. Sellers
CREATE OR REPLACE TABLE silver.sellers
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/sellers'
AS
SELECT 
    TRIM(seller_id) AS seller_id,
    CAST(TRIM(seller_zip_code_prefix) AS INT) AS seller_zip_code_prefix,
    UPPER(TRIM(seller_city)) AS seller_city,
    UPPER(TRIM(seller_state)) AS seller_state
FROM bronze.sellers;

-- 5. Geolocation
CREATE OR REPLACE TABLE silver.geolocation
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/geolocation'
AS
SELECT 
    CAST(TRIM(geolocation_zip_code_prefix) AS INT) AS geolocation_zip_code_prefix,
    CAST(TRIM(geolocation_lat) AS DOUBLE) AS geolocation_lat,
    CAST(TRIM(geolocation_lng) AS DOUBLE) AS geolocation_lng,
    UPPER(TRIM(geolocation_city)) AS geolocation_city,
    UPPER(TRIM(geolocation_state)) AS geolocation_state
FROM bronze.geolocation;

-- 6. Orders
CREATE OR REPLACE TABLE silver.orders
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/orders/'
AS
SELECT 
    TRIM(order_id) AS order_id,
    TRIM(customer_id) AS customer_id,
    UPPER(TRIM(order_status)) AS order_status,
    to_timestamp(TRIM(order_purchase_timestamp), 'yyyy-MM-dd HH:mm:ss') AS order_purchase_timestamp,
    to_timestamp(TRIM(order_approved_at), 'yyyy-MM-dd HH:mm:ss') AS order_approved_at,
    to_timestamp(TRIM(order_delivered_carrier_date), 'yyyy-MM-dd HH:mm:ss') AS order_delivered_carrier_date,
    to_timestamp(TRIM(order_delivered_customer_date), 'yyyy-MM-dd HH:mm:ss') AS order_delivered_customer_date,
    to_timestamp(TRIM(order_estimated_delivery_date), 'yyyy-MM-dd HH:mm:ss') AS order_estimated_delivery_date,
    CASE WHEN order_delivered_customer_date IS NOT NULL THEN 1 ELSE 0 END AS is_delivered
FROM bronze.orders;

-- 7. Order Items
CREATE OR REPLACE TABLE silver.order_items
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/order_items'
AS
SELECT 
    TRIM(order_id) AS order_id,
    CAST(TRIM(order_item_id) AS INT) AS order_item_id,
    TRIM(product_id) AS product_id,
    TRIM(seller_id) AS seller_id,
    to_timestamp(TRIM(shipping_limit_date), 'yyyy-MM-dd HH:mm:ss') AS shipping_limit_date,
    CAST(TRIM(price) AS DECIMAL(10,2)) AS price,
    CAST(TRIM(freight_value) AS DECIMAL(10,2)) AS freight_value
FROM bronze.order_items;

-- 8. Order Payments
CREATE OR REPLACE TABLE silver.order_payments
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/order_payments'
AS
SELECT 
    TRIM(order_id) AS order_id,
    CAST(TRIM(payment_sequential) AS INT) AS payment_sequential,
    UPPER(TRIM(payment_type)) AS payment_type,
    CAST(TRIM(payment_installments) AS INT) AS payment_installments,
    CAST(TRIM(payment_value) AS DECIMAL(10,2)) AS payment_value
FROM bronze.order_payments;

-- 9. Order Reviews
CREATE OR REPLACE TABLE silver.order_reviews
USING DELTA
LOCATION 's3://etl-project3-data-warehouse-in-cloud/silver/order_reviews'
AS
SELECT 
    TRIM(review_id) AS review_id,
    TRIM(order_id) AS order_id,
    CAST(TRIM(review_score) AS INT) AS review_score,
    NULLIF(TRIM(review_comment_title), '') AS review_comment_title,
    NULLIF(TRIM(review_comment_message), '') AS review_comment_message,
    to_timestamp(TRIM(review_creation_date), 'yyyy-MM-dd HH:mm:ss') AS review_creation_date,
    to_timestamp(TRIM(review_answer_timestamp), 'yyyy-MM-dd HH:mm:ss') AS review_answer_timestamp
FROM bronze.order_reviews;
